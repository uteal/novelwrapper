/*! NovelWrapper v0.3.4 | (c) 2024 uteal | MIT License */export default(K,L,{$:xe={},ext:Ee={},callbacks:P=[],devMode:Z=!0,stepTime:Se=1e3/60,cssPrefix:n="novel",watchedAttr:$=void 0,imagesPath:ae="./images/",imagesType:Le="png",firstScene:$e="start",restoreFromSlot:oe="autosave",useLocationHash:D=!1,appendTo:M=document.body,implementations:Oe={},delays:Ce={},defaultAlign:le="right",multiLangSplitRegex:Te=/\s+>>\s+/,language:_=-1}={})=>{if(!L||Array.isArray(L)&&!L.length)throw new Error("You should provide at least one scene factory function.");const ce="Sakura",Ae=ae+(ae.endsWith("/")?"":"/"),Re=Le.toLowerCase();let B=!1;const G="AbortSignal",ee={},x=()=>{if(B)throw G},d={},A={},he={},j=[],F={};let U,p,u,de,J,z,V,W=0,R=!1,Y=!1,k=!1,Q=!1,te=!1,q=!1,H,E,O,h,se,f,C,T;const v={CHARACTER_SHOW:350,CHARACTER_HIDE:350,CHARACTER_MOOD_CHANGE:100,BEFORE_SELECT_ACTIVE:350,AFTER_OPTION_CLICK:250,BEFORE_FIRST_PRINT:500,BEFORE_SKIP_PRINTING:200,BEFORE_IDLE_PROCEED:500},c={onGameStart:null,onShow:null,onHide:null,onType:null,onStop:null,onSceneEnter:null,onSceneLeave:null,onWatcherCreate:null,onWatcherRemove:null,onEventEnter:null,onEventLeave:null,onShowOptions:null,onOptionClick:null,onStateChange:null,onGameEnd:null},w={createKey(t,e){return`${t}(${e})`},writeState(t,e){if(D){let s={};try{s=JSON.parse(decodeURIComponent(window.location.hash).slice(1))}catch{}s[t]=e,window.history.pushState(void 0,void 0,"#"+JSON.stringify(s))}else localStorage.setItem(t,JSON.stringify(e))},readState(t){if(l("\u21BB",t),D){let e={};try{e=JSON.parse(decodeURIComponent(window.location.hash).slice(1))}catch{}return e[t]}else{let e;try{e=JSON.parse(localStorage.getItem(t))}catch{}return e}},clearSavedState(t){if(l("\u{1F5D1}\uFE0F",t),D){let e={};try{e=JSON.parse(decodeURIComponent(window.location.hash).slice(1))}catch{}delete e[t],window.history.replaceState(void 0,void 0,"#"+JSON.stringify(e))}else localStorage.removeItem(t)},onUserNavigates(){D&&window.history.go(0)}},ue=new Proxy(d,{set(t,e,s){return t.$[e]=s,c.onStateChange?.(e,s),!0},get(t,e){return t.$[e]}}),fe=new Proxy(he,{get(t,e){return Object.hasOwn(t,e)||(t[e]=new ne(e)),t[e].proxy}}),I=(t=!1)=>{if(!B&&(k||t)&&J){k=!1;const e=J;J=null,e()}},ke=async({target:t})=>{if(!B&&k&&z&&t?.classList.contains(n+"-select-option")){k=!1,c.onOptionClick?.();const e=t.getAttribute("select-option-value")??[...T.querySelectorAll("."+n+"-select-option")].findIndex(i=>t===i);T.classList.add(n+"-select-hidden");const s=z;z=null,l("\u{1F449}",t.innerText),await b(v.AFTER_OPTION_CLICK),Y=!1,s(e)}};class Ie{constructor(){Object.assign(v,Ce),H=y(n+"-container",n+"-layer"),E=y(n+"-dialogs",n+"-layer"),O=y(n+"-choices",n+"-layer"),h=y(n+"-textbox",n+"-textbox-hidden"),se=y(n+"-message"),f=me(n+"-message-rendered"),C=me(n+"-message-placeholder"),T=y(n+"-select",n+"-select-hidden"),H.append(E,O),se.append(f,C),h.append(se),E.append(h),O.append(T),E.addEventListener("click",()=>I()),T.addEventListener("click",s=>ke(s)),Array.isArray(P)||(P=[P]),$&&P.push(Fe()),this.setCallbacks(P);for(const[s,i]of Object.entries(Oe))Object.hasOwn(w,s)?w[s]=i:console.error(`Unknown name for implementation given: "${s}".`);this.getScenes(),typeof M=="string"&&(M=document.querySelector(M)),M.append(H);const e=!!oe&&this.loadState(oe);e&&e.version===ce?Object.assign(d,e):(l("\u{1F3AC}",K),Object.assign(d,this.createNewState()),Object.assign(d.$,xe)),l("\u{1F4E6}",structuredClone(d)),N(()=>{this.runScene(d.scene,!1),c.onGameStart?.(ee)})}setCallbacks(e){const s=Object.fromEntries(Object.keys(c).map(i=>[i,[]]));for(const i of e)for(const[r,a]of Object.entries(i)){if(!Object.hasOwn(s,r)){console.error("Unknown callback:",r);continue}s[r].push(a)}for(const[i,r]of Object.entries(s))r.length>0&&(c[i]=r.length===1?r[0]:function(...a){r.forEach(o=>o.apply(this,a))})}getScenes(){Array.isArray(L)||(L=[L]);for(const e of L)Object.entries(e({$:ue,watch:Pe,select:je,call:qe,print:He,clear:Ke,sleep:b,save:this.saveState,log:l,ext:Ee})).forEach(([s,i])=>{Object.hasOwn(A,s)?console.error("Scene redeclaration:",s):A[s]=new Ne(s,i)})}saveState(e="autosave"){x();const s=w.createKey?.(K,e);w.writeState?.(s,structuredClone(d))}loadState(e){x();const s=w.createKey?.(K,e);return w.readState?.(s)}clearSaveSlot(e){x();const s=w.createKey?.(K,e);w.clearSavedState?.(s)}createNewState(){return{$:{},scene:$e,characters:{},version:ce}}async runScene(e,s=!0){if(x(),l("\u26F0\uFE0F",e),e?.[0]==="~"?e=e.slice(1):u?.hide(),p&&p.end(),!Object.hasOwn(A,e)){console.error("Trying to run unknown scene:",e);return}p=A[e],d.scene=e,s&&this.saveState("autosave"),c.onSceneEnter?.(e,!0);let i;try{i=await p.run()}catch(r){if(r===G){l("\u270B","The game was manually interrupted."),l("\u{1FA82}","Emergency exiting.");return}else throw r}c.onSceneLeave?.(e,!0),typeof i=="string"?setTimeout(()=>this.runScene(i)):i!==void 0&&(l("\u{1F3C1}","Game ended."),c.onGameEnd?.(i))}async notify(e,...s){if(x(),l("\u26A1",e),!p){console.error(`Event "${e}" occured while no scene is active`);return}if(!Q){console.error(`Event "${e}" occured while the script flow was not ended.`);return}const i=p.watchers.find(r=>r.event===e);if(!i){l("\u{1F965}","No such watcher.");return}if(!i.cb){l("\u{1F34B}","Callback not set.");return}if(i){Q=!1,c.onEventEnter?.(e,...s);let r;try{r=await i.cb(...s)}catch(a){if(a===G){l("\u270B","The game was manually interrupted."),l("\u{1FA82}","Emergency exiting.");return}else throw a}c.onEventLeave?.(e,r),typeof r=="string"?de(r):(r===!1&&p.removeWatcher(e),u?.hide(),O.style.pointerEvents="none",E.style.pointerEvents="none",Q=!0,l("\u26F0\uFE0F",p.id,"\u21A9"))}}}class Ne{watchers=[];constructor(e,s){this.id=e,this.cb=s}async run(){let e=await this.cb(fe);return e===void 0&&(this.watchers.length?(Q=!0,u?.hide(),O.style.pointerEvents="none",E.style.pointerEvents="none",H.style.pointerEvents="none",e=await new Promise(s=>{de=s})):l("\u{1F6A7}","The game has stalled.")),e}removeWatcher(e){const s=this.watchers.findIndex(i=>i.event===e);s!==-1&&(this.watchers.splice(s,1),c.onWatcherRemove?.(e),l("\u{1F9F9}",e))}end(){this.watchers.forEach(({event:e})=>{c.onWatcherRemove?.(e)}),this.watchers=[]}}function Pe(t,e){if(x(),p.watchers.some(i=>i.event===t)){console.error(`Multiple watchers of the same event (${t}) not allowed at scene (${p.id})`);return}l("\u{1F4CC}",t),p.watchers.push({event:t,cb:e}),c.onWatcherCreate?.(t);const s=p.id;return{then:()=>{console.error(`There is no point in "await" before "watch" (scene: "${s}", event: "${t}").`)}}}class ne{constructor(e){l("\u{1F98A}",e),this.id=e,this.label="",this.align=le,this.flipped=!1,this.visible=!1,this.timeout,this.mood="normal",this.queue=[];let s="normal";const i=(...r)=>{if(Z){for(const{id:a,queue:o}of Object.values(he))if(o.length){console.error(`Unexpected state. Check the "await" before these words of ${a}:`,[...o]);return}}return this.proxy__(...r)};if(Object.assign(i,{$toLeft:()=>(this.setAlign("left"),d.characters[e].align="left",this.proxy_),$toRight:()=>(this.setAlign("right"),d.characters[e].align="right",this.proxy_),$setName:r=>(this.setLabel(r),d.characters[e].label=r,this.proxy_),$flipImage:()=>(this.setFlip(!this.flipped),d.characters[e].flipped=this.flipped,this.proxy_),then:()=>{console.error(`Seemingly useless "await" before ${this.id}'s handle. This error may be caused by:
1. Erroneous usage of "await" with syncronous methods like "$toLeft", "$toRight", "$setName".
2. Using quotes or double quotes instead of backticks in parenthesis-less notation.
3. Using a comma or semicolon before the first argument in parenthesis-less notation.`)}}),this.proxy=new Proxy(i,{get:(r,a)=>Object.hasOwn(r,a)?r[a]:(s=a,this.proxy__)}),this.proxy_=new Proxy(i,{apply:()=>{console.error("Direct function call in a method chain. Chaining of methods and function calls is prohibited.")}}),this.proxy__=new Proxy(i,{get:(r,a)=>{if(a==="then")return async(o,m)=>{const g=this.queue;this.queue=[],await this.say(s,...g).catch(m),s="normal",o()};console.error(`Once the call chain has started, property getting is not allowed. Requested property: "${a}".`)},apply:(r,a,o)=>(Array.isArray(o[0])&&Array.isArray(o[0].raw)&&(o=[De(...o)]),this.queue.push(...o),this.proxy__)}),this.$el=y(n+"-character",n+"-character-id-"+e,n+"-character-align-"+this.align,n+"-character-inactive"),this.$portraits=y(n+"-character-portraits"),this.$label=y(n+"-label",n+"-label-id-"+e,n+"-label-hidden"),this.$el.append(this.$portraits,this.$label),Object.hasOwn(d.characters,e)){const r=d.characters[e];this.setLabel(r.label),this.setAlign(r.align),this.setFlip(r.flipped),l("\u21BB",r)}else d.characters[e]={}}setLabel(e=""){this.$label.innerText=e,this.label=e,e?this.visible&&this.$label.classList.remove(n+"-label-hidden"):this.$label.classList.add(n+"-label-hidden")}setAlign(e=le){e!==this.align&&(this.$el.classList.remove(n+"-character-align-"+this.align),this.$el.classList.add(n+"-character-align-"+e),this.align=e,this.visible&&this.updateTextboxAlign())}setFlip(e=!1){this.flipped=e,e?this.$el.classList.add(n+"-character-flipped"):this.$el.classList.remove(n+"-character-flipped")}setMood(e){return e!==this.mood?(this.$el.classList.remove(n+"-character-mood-"+this.mood),this.$el.classList.add(n+"-character-mood-"+e),this.mood=e,!0):!1}async show(e=this.mood){const s=this.setMood(e),i=!!u&&u===this,r=!!u&&u.align===this.align;let a=this.$portraits.querySelector("."+n+"-portrait-mood-"+e);a?a.classList.contains(n+"-portrait-hidden")&&this.$portraits.append(a):(a=y(n+"-portrait",n+"-portrait-mood-"+e,n+"-portrait-hidden"),this.$portraits.append(a),await new Promise(o=>{let m=`${Ae}${this.id}/${e}.${Re}`;Z&&(m+="?"+Math.random());const g=new Image;g.src=m,g.onload=()=>{a.style.backgroundImage=`url('${m}')`,o()},g.onerror=()=>{o()}})),i||(r?await u?.hide():u?.hide()),a.classList.contains(n+"-portrait-hidden")&&N(()=>{a.classList.remove(n+"-portrait-hidden")}),this.visible?await N(async()=>{await b(s?v.CHARACTER_MOOD_CHANGE:0);for(let o=0;o<this.$portraits.children.length-1;o++)this.$portraits.children[o].classList.add(n+"-portrait-hidden");this.updateTextboxAlign()}):(this.visible=!0,u=this,f.innerText="",C.innerText="",E.append(this.$el),clearTimeout(this.timeout),c.onShow?.(this.id),await N(()=>{this.$el.classList.remove(n+"-character-inactive"),h.classList.remove(n+"-textbox-hidden");for(let o=h.classList.length-1;o>=0;o--){const m=h.classList[o];m.startsWith(n+"-textbox-of-")&&h.classList.remove(m)}h.classList.add(n+"-textbox-of-"+this.id),this.updateTextboxAlign()}),this.label?this.$label.classList.remove(n+"-label-hidden"):this.$label.classList.add(n+"-label-hidden"),await b(v.CHARACTER_SHOW))}async hide(){if(!this)await N(()=>{R||h.classList.add(n+"-textbox-hidden")});else if(this.visible){this.visible=!1,u=void 0,this.$el.classList.remove(n+"-character-mood-"+this.mood),this.$el.classList.add(n+"-character-inactive"),this.$label.classList.add(n+"-label-hidden");for(const e of this.$portraits.children)e.classList.add(n+"-portrait-hidden");await N(()=>{R||h.classList.add(n+"-textbox-hidden")}),c.onHide?.(this.id),this.timeout=setTimeout(()=>this.$el.remove(),5e3),await b(v.CHARACTER_HIDE)}}updateTextboxAlign(){this.align==="left"?(h.classList.remove(n+"-textbox-right"),h.classList.add(n+"-textbox-left")):(h.classList.remove(n+"-textbox-left"),h.classList.add(n+"-textbox-right"))}async say(e,...s){if(x(),R||Y){console.error("Message from "+(this?.id??"[print]")+' was ignored because the previous task was not finished. Check if you placed "await"s correctly.'),console.error("Message:",s);return}R=!0,E.style.pointerEvents="all",O.style.pointerEvents="none";const i=[];for(const r of s)Array.isArray(r)?i.push(...r):i.push(r);if(this)h.classList.remove(n+"-textbox-printed"),await this.show(e);else{const r=h.classList.contains(n+"-textbox-hidden"),a=r||!!u;u?.hide(),f.innerText="",C.innerText="",h.classList.remove(n+"-textbox-left"),h.classList.remove(n+"-textbox-right"),h.classList.add(n+"-textbox-printed"),r&&h.classList.remove(n+"-textbox-hidden"),a&&await b(v.BEFORE_FIRST_PRINT)}for(let r=0;r<i.length;r++){if(typeof i[r]!="string")continue;let a=!1,o=0,m=Se,g=[];typeof i[r+1]=="number"&&(a=!0,o=i[r+1]);let S=i[r];if(S[0]==="["){const X=S.indexOf("]");g=S.slice(1,X).split(""),S=S.slice(X+1)}g.includes("~")&&(m=m*2),m>0?await Me(S,m,g.includes("+")):g.includes("+")?f.innerText+=S:f.innerText=S,g.includes("+")&&j.pop(),j.push({id:this?.id??"[print]",label:this?.label??"[print]",text:f.innerText}),j.length>100&&j.shift(),a?f.classList.add(n+"-message-rendered-writing"):f.classList.add(n+"-message-rendered-stopped");let ge;const Be=new Promise((X,Ge)=>{ge=X,V=Ge}),ve=()=>(k=!0,c.onStop?.(),Be);J=()=>{f.classList.remove(n+"-message-rendered-writing"),f.classList.remove(n+"-message-rendered-stopped"),ge()},q&&await b(v.BEFORE_SKIP_PRINTING),q?I(!0):a?(await b(o),I(!0)):F[" "]?(await b(v.BEFORE_IDLE_PROCEED),F[" "]?I(!0):await ve()):await ve()}R=!1}}async function je(...t){if(x(),l("\u{1F4CB}",t),R||Y){console.error('Cannot show selectable options because the previous task was not finished. Check if you placed "await"s correctly.'),console.error("Options:",t);return}if(t=t.filter(e=>typeof e=="string"||e instanceof Object),!!t.length)return Y=!0,k=!0,O.style.pointerEvents="all",T.replaceChildren(...t.map(e=>{const s=y(n+"-select-option");if(typeof e=="string")s.innerText=re(e);else{const[i,r]=Object.entries(e)[0];s.innerText=re(r),s.setAttribute("select-option-value",i)}return s})),T.classList.remove(n+"-select-hidden"),c.onShowOptions?.(),await b(v.BEFORE_SELECT_ACTIVE),new Promise((e,s)=>{V=s,z=e})}const pe=(t,...e)=>{const s=document.createElement(t);return s.classList.add(...e),s},y=pe.bind(null,"div"),me=pe.bind(null,"span");function N(t){return new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(async()=>{await t(),e()})})})}function Fe(){const t=[];return{onWatcherCreate(e){document.querySelectorAll(`[${$}="${e}"]`).forEach(s=>{s.classList.add(n+"-watched"),s.addEventListener("click",ie),t.push(s)})},onWatcherRemove(e){for(let s=t.length-1;s>=0;s--){const i=t[s];i.getAttribute($)===e&&(i.classList.remove(n+"-watched"),i.removeEventListener("click",ie),t.splice(s,1))}},onEventEnter(e){t.forEach(s=>{s.getAttribute($)===e?s.classList.add(n+"-watched-clicked"):s.classList.add(n+"-watched-clicked-other")})},onEventLeave(){t.forEach(e=>{e.classList.remove(n+"-watched-clicked"),e.classList.remove(n+"-watched-clicked-other")})}}}function ie(){U.notify(this.getAttribute($))}function We(){document.removeEventListener("keydown",we),document.removeEventListener("keyup",ye),window.removeEventListener("popstate",be),$&&document.querySelectorAll(`[${$}]`).forEach(t=>{t.removeEventListener("click",ie),t.classList.remove(n+"-watched"),t.classList.remove(n+"-watched-clicked"),t.classList.remove(n+"-watched-clicked-other")})}function qe(t,...e){if(!Object.hasOwn(A,t)){console.error("Trying to call unknown scene:",t);return}if(W>99){console.error(`Scene "${t}" cannot be called: stack size limit reached (${W}).`);return}return W+=1,l("\u{1F4AC}",t),(async()=>{c.onSceneEnter?.(t,!1);const s=await A[t].cb(fe,...e);return c.onSceneLeave?.(t,!1),W-=1,W||l("\u26F0\uFE0F",p?.id,"\u21A9"),s})()}function He(...t){return ne.prototype.say.call(null,null,...t)}function Ke(){return u?u.hide():ne.prototype.hide.call(null)}function b(t){return new Promise((e,s)=>{V=s,setTimeout(e,t)})}function re(t){if(_!==-1&&typeof t=="string"){const e=t.split(Te);return _<e.length?e[_]:e[0]}return t}function De(t,...e){let s="";for(let i=0;i<t.length;i++)s+=t[i],i<t.length-1&&(s+=`${e[i]}`);return s}function Me(t,e,s){return t=re(t),s||(f.innerText="",C.innerText=t),new Promise(i=>{const r=a=>{q?(f.innerText+=t.slice(a),s||(C.innerText=""),i()):a<t.length?setTimeout(()=>{f.innerText+=t[a],s||(C.innerText=t.slice(a+1)),c.onType?.(t[a]),r(a+1)},te?0:e):i()};r(0)})}function l(...t){Z&&console.log(...t.map(e=>e===ue?d.$:e))}const we=({key:t})=>{if(!F[t])switch(F[t]=!0,t){case" ":te=!0,I();break;case"Control":I(),q=!0;break}},ye=({key:t})=>{switch(delete F[t],t){case" ":te=!1;break;case"Control":q=!1;break}},be=t=>{w.onUserNavigates?.()};return document.addEventListener("keydown",we),document.addEventListener("keyup",ye),window.addEventListener("popstate",be),U=new Ie,Object.assign(ee,{event:(t,...e)=>{U.notify(t,...e)},getHistory:()=>j,clearSaveSlot:(t="autosave")=>{U.clearSaveSlot(t)},remove:()=>{B=!0,We(),H.remove();for(const t of Object.keys(c))c[t]=null;for(const t of Object.keys(w))w[t]=null;V?.(G)},sleep:b,log:l}),ee};
