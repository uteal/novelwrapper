/*! NovelWrapper v0.3.3 | (c) 2024 uteal | MIT License */export default(q,K,{$:ge={},ext:ve={},callbacks:k=[],devMode:X=!0,stepTime:xe=1e3/60,cssPrefix:n="novel",watchedAttr:S=void 0,imagesPath:ie="./images/",imagesType:Ee="png",firstScene:Le="start",restoreFromSlot:re="autosave",appendTo:D=document.body,implementations:Se={},delays:$e={},defaultAlign:ae="right",multiLangSplitRegex:Oe=/\s+>>\s+/,language:Z=-1})=>{const oe="Naruto",Ce=ie+(ie.at(-1)!=="/"?"/":""),Te=Ee.toLowerCase();let M=!1;const B="AbortSignal",_={},x=()=>{if(M)throw B},d={},T={},le={},I=[],G={};let N,p,u,ce,U,z,J,P=0,j=!1,V=!1,A=!1,Y=!1,ee=!1,F=!1,W,E,$,h,te,f,O,C;const v={CHARACTER_SHOW:350,CHARACTER_HIDE:350,CHARACTER_MOOD_CHANGE:100,BEFORE_SELECT_ACTIVE:350,AFTER_OPTION_CLICK:250,BEFORE_FIRST_PRINT:500,BEFORE_SKIP_PRINTING:200,BEFORE_IDLE_PROCEED:500},c={onGameStart:null,onShow:null,onHide:null,onType:null,onStop:null,onSceneEnter:null,onSceneLeave:null,onWatcherCreate:null,onWatcherRemove:null,onEventEnter:null,onEventLeave:null,onShowOptions:null,onOptionClick:null,onStateChange:null,onGameEnd:null},g={createKey(t,e){return`novel : ${t} : ${e}`},writeState(t,e){localStorage.setItem(t,JSON.stringify(e)),o("\u{1F4BE}",t,e)},readState(t){let e;try{e=JSON.parse(localStorage.getItem(t))}catch{}if(e)return o("\u21BB",t,e),e},clearSavedState(t){localStorage.removeItem(t),o("\u{1F5D1}\uFE0F",t)}},he=new Proxy(d,{set(t,e,s){return e.startsWith("__")?(console.error('Could not set property that starts with "__": such names are reserved by the engine.'),!1):(t[e]=s,c.onStateChange?.(e,s),!0)}}),de=new Proxy(le,{get(t,e){return Object.hasOwn(t,e)||(t[e]=new ue(e)),t[e].proxy}}),R=(t=!1)=>{if(!M&&(A||t)&&U){A=!1;const e=U;U=null,e()}},Ae=async({target:t})=>{if(!M&&A&&z&&t?.classList.contains(n+"-select-option")){A=!1,c.onOptionClick?.();const e=t.getAttribute("select-option-value")??[...C.querySelectorAll("."+n+"-select-option")].findIndex(i=>t===i);C.classList.add(n+"-select-hidden");const s=z;z=null,o("\u{1F449}",t.innerText),await y(v.AFTER_OPTION_CLICK),V=!1,s(e)}};class Re{constructor(){Object.assign(v,$e),W=b(n+"-container",n+"-layer"),E=b(n+"-dialogs",n+"-layer"),$=b(n+"-choices",n+"-layer"),h=b(n+"-textbox",n+"-textbox-hidden"),te=b(n+"-message"),f=pe(n+"-message-rendered"),O=pe(n+"-message-placeholder"),C=b(n+"-select",n+"-select-hidden"),W.append(E,$),te.append(f,O),h.append(te),E.append(h),$.append(C),E.addEventListener("click",()=>R()),C.addEventListener("click",s=>Ae(s)),Array.isArray(k)||(k=[k]),S&&k.push(Pe()),this.setCallbacks(k);for(const[s,i]of Object.entries(Se))Object.hasOwn(g,s)?g[s]=i:console.error(`Unknown name for implementation given: "${s}".`);this.getScenes(),typeof D=="string"&&(D=document.querySelector(D)),D.append(W);const e=!!re&&this.loadState(re);e&&e.__version===oe?Object.assign(d,e):(o("\u{1F3AC}",q),Object.assign(d,this.createNewState()),Object.assign(d,me(ge))),o("\u{1F4E6}",structuredClone(d)),H(()=>{this.runScene(d.__scene,!1),c.onGameStart?.(_)})}setCallbacks(e){const s=Object.fromEntries(Object.keys(c).map(i=>[i,[]]));for(const i of e)for(const[r,a]of Object.entries(i)){if(!Object.hasOwn(s,r)){console.error("Unknown callback:",r);continue}s[r].push(a)}for(const[i,r]of Object.entries(s))r.length>0&&(c[i]=r.length===1?r[0]:function(...a){r.forEach(l=>l.apply(this,a))})}getScenes(){Array.isArray(K)||(K=[K]);for(const e of K)Object.entries(e({$:he,watch:Ie,select:Ne,call:Fe,print:We,clear:He,sleep:y,log:o,ext:ve})).forEach(([s,i])=>{Object.hasOwn(T,s)?console.error("Scene redeclaration:",s):T[s]=new ke(s,i)})}saveState(e){x();const s=g.createKey?.(q,e);g.writeState?.(s,structuredClone(d))}loadState(e){x();const s=g.createKey?.(q,e);return g.readState?.(s)}clearSaveSlot(e){x();const s=g.createKey?.(q,e);g.clearSavedState?.(s)}createNewState(){return{__scene:Le,__characters:{},__version:oe}}async runScene(e,s=!0){if(x(),o("\u26F0\uFE0F",e),e?.[0]==="~"?e=e.slice(1):u?.hide(),p&&p.end(),!Object.hasOwn(T,e)){console.error("Trying to run unknown scene:",e);return}p=T[e],d.__scene=e,s&&this.saveState("autosave"),c.onSceneEnter?.(e,!0);let i;try{i=await p.run()}catch(r){if(r===B){o("\u270B","The game was manually interrupted."),o("\u{1FA82}","Emergency exiting.");return}else throw r}c.onSceneLeave?.(e,!0),typeof i=="string"?setTimeout(()=>this.runScene(i)):i!==void 0&&(o("\u{1F3C1}","Game ended."),c.onGameEnd?.(i))}async notify(e,...s){if(x(),o("\u26A1",e),!p){console.error(`Event "${e}" occured while no scene is active`);return}if(!Y){console.error(`Event "${e}" occured while the script flow was not ended.`);return}const i=p.watchers.find(r=>r.event===e);if(!i){o("\u{1F965}","No such watcher.");return}if(!i.cb){o("\u{1F34B}","Callback not set.");return}if(i){Y=!1,c.onEventEnter?.(e,...s);let r;try{r=await i.cb(...s)}catch(a){if(a===B){o("\u270B","The game was manually interrupted."),o("\u{1FA82}","Emergency exiting.");return}else throw a}c.onEventLeave?.(e,r),typeof r=="string"?ce(r):(r===!1&&p.removeWatcher(e),u?.hide(),$.style.pointerEvents="none",E.style.pointerEvents="none",Y=!0,o("\u26F0\uFE0F",p.id,"\u21A9"))}}}class ke{watchers=[];constructor(e,s){this.id=e,this.cb=s}async run(){let e=await this.cb(de);return e===void 0&&(this.watchers.length?(Y=!0,u?.hide(),$.style.pointerEvents="none",E.style.pointerEvents="none",W.style.pointerEvents="none",e=await new Promise(s=>{ce=s})):o("\u{1F6A7}","The game has stalled.")),e}removeWatcher(e){const s=this.watchers.findIndex(i=>i.event===e);s!==-1&&(this.watchers.splice(s,1),c.onWatcherRemove?.(e),o("\u{1F9F9}",e))}end(){this.watchers.forEach(({event:e})=>{c.onWatcherRemove?.(e)}),this.watchers=[]}}function Ie(t,e){if(x(),p.watchers.some(i=>i.event===t)){console.error(`Multiple watchers of the same event (${t}) not allowed at scene (${p.id})`);return}o("\u{1F4CC}",t),p.watchers.push({event:t,cb:e}),c.onWatcherCreate?.(t);const s=p.id;return{then:()=>{console.error(`There is no point in "await" before "watch" (scene: "${s}", event: "${t}").`)}}}class ue{constructor(e){o("\u{1F98A}",e),this.id=e,this.label="",this.align=ae,this.flipped=!1,this.visible=!1,this.timeout,this.mood="normal",this.queue=[];let s="normal";const i=(...r)=>{if(X){for(const{id:a,queue:l}of Object.values(le))if(l.length){console.error(`Unexpected state. Check the "await" before these words of ${a}:`,[...l]);return}}return this.proxy__(...r)};if(Object.assign(i,{$toLeft:()=>(this.setAlign("left"),d.__characters[e].align="left",this.proxy_),$toRight:()=>(this.setAlign("right"),d.__characters[e].align="right",this.proxy_),$setName:r=>(this.setLabel(r),d.__characters[e].label=r,this.proxy_),$flipImage:()=>(this.setFlip(!this.flipped),d.__characters[e].flipped=this.flipped,this.proxy_),then:()=>{console.error(`Seemingly useless "await" before ${this.id}'s handle. This error may be caused by:
1. Erroneous usage of "await" with syncronous methods like "$toLeft", "$toRight", "$setName".
2. Using quotes or double quotes instead of backticks in parenthesis-less notation.
3. Using a comma or semicolon before the first argument in parenthesis-less notation.`)}}),this.proxy=new Proxy(i,{get:(r,a)=>Object.hasOwn(r,a)?r[a]:(s=a,this.proxy__)}),this.proxy_=new Proxy(i,{apply:()=>{console.error("Direct function call in a method chain. Chaining of methods and function calls is prohibited.")}}),this.proxy__=new Proxy(i,{get:(r,a)=>{if(a==="then")return async(l,m)=>{const w=this.queue;this.queue=[],await this.say(s,...w).catch(m),s="normal",l()};console.error(`Once the call chain has started, property getting is not allowed. Requested property: "${a}".`)},apply:(r,a,l)=>(Array.isArray(l[0])&&Array.isArray(l[0].raw)&&(l=[qe(...l)]),this.queue.push(...l),this.proxy__)}),this.$el=b(n+"-character",n+"-character-id-"+e,n+"-character-align-"+this.align,n+"-character-inactive"),this.$portraits=b(n+"-character-portraits"),this.$label=b(n+"-label",n+"-label-id-"+e,n+"-label-hidden"),this.$el.append(this.$portraits,this.$label),Object.hasOwn(d.__characters,e)){const r=d.__characters[e];this.setLabel(r.label),this.setAlign(r.align),this.setFlip(r.flipped),o("\u21BB",r)}else d.__characters[e]={}}setLabel(e=""){this.$label.innerText=e,this.label=e,e?this.visible&&this.$label.classList.remove(n+"-label-hidden"):this.$label.classList.add(n+"-label-hidden")}setAlign(e=ae){e!==this.align&&(this.$el.classList.remove(n+"-character-align-"+this.align),this.$el.classList.add(n+"-character-align-"+e),this.align=e,this.visible&&this.updateTextboxAlign())}setFlip(e=!1){this.flipped=e,e?this.$el.classList.add(n+"-character-flipped"):this.$el.classList.remove(n+"-character-flipped")}setMood(e){return e!==this.mood?(this.$el.classList.remove(n+"-character-mood-"+this.mood),this.$el.classList.add(n+"-character-mood-"+e),this.mood=e,!0):!1}async show(e=this.mood){const s=this.setMood(e),i=!!u&&u===this,r=!!u&&u.align===this.align;let a=this.$portraits.querySelector("."+n+"-portrait-mood-"+e);a?a.classList.contains(n+"-portrait-hidden")&&this.$portraits.append(a):(a=b(n+"-portrait",n+"-portrait-mood-"+e,n+"-portrait-hidden"),this.$portraits.append(a),await new Promise(l=>{let m=`${Ce}${this.id}/${e}.${Te}`;X&&(m+="?"+Math.random());const w=new Image;w.src=m,w.onload=()=>{a.style.backgroundImage=`url('${m}')`,l()},w.onerror=()=>{l()}})),i||(r?await u?.hide():u?.hide()),a.classList.contains(n+"-portrait-hidden")&&H(()=>{a.classList.remove(n+"-portrait-hidden")}),this.visible?await H(async()=>{await y(s?v.CHARACTER_MOOD_CHANGE:0);for(let l=0;l<this.$portraits.children.length-1;l++)this.$portraits.children[l].classList.add(n+"-portrait-hidden");this.updateTextboxAlign()}):(this.visible=!0,u=this,f.innerText="",O.innerText="",E.append(this.$el),clearTimeout(this.timeout),c.onShow?.(this.id),await H(()=>{this.$el.classList.remove(n+"-character-inactive"),h.classList.remove(n+"-textbox-hidden");for(let l=h.classList.length-1;l>=0;l--){const m=h.classList[l];m.startsWith(n+"-textbox-of-")&&h.classList.remove(m)}h.classList.add(n+"-textbox-of-"+this.id),this.updateTextboxAlign()}),this.label?this.$label.classList.remove(n+"-label-hidden"):this.$label.classList.add(n+"-label-hidden"),await y(v.CHARACTER_SHOW))}async hide(){if(this.visible){this.visible=!1,u=void 0,this.$el.classList.remove(n+"-character-mood-"+this.mood),this.$el.classList.add(n+"-character-inactive"),this.$label.classList.add(n+"-label-hidden");for(const e of this.$portraits.children)e.classList.add(n+"-portrait-hidden");await H(()=>{j||h.classList.add(n+"-textbox-hidden")}),c.onHide?.(this.id),this.timeout=setTimeout(()=>this.$el.remove(),5e3),await y(v.CHARACTER_HIDE)}}updateTextboxAlign(){this.align==="left"?(h.classList.remove(n+"-textbox-right"),h.classList.add(n+"-textbox-left")):(h.classList.remove(n+"-textbox-left"),h.classList.add(n+"-textbox-right"))}async say(e,...s){if(x(),j||V){console.error("Message from "+(this?.id??"[print]")+' was ignored because the previous task was not finished. Check if you placed "await"s correctly.'),console.error("Message:",s);return}j=!0,E.style.pointerEvents="all",$.style.pointerEvents="none";const i=[];for(const r of s)Array.isArray(r)?i.push(...r):i.push(r);if(this)h.classList.remove(n+"-textbox-printed"),await this.show(e);else{const r=h.classList.contains(n+"-textbox-hidden"),a=r||!!u;u?.hide(),f.innerText="",O.innerText="",h.classList.remove(n+"-textbox-left"),h.classList.remove(n+"-textbox-right"),h.classList.add(n+"-textbox-printed"),r&&h.classList.remove(n+"-textbox-hidden"),a&&await y(v.BEFORE_FIRST_PRINT)}for(let r=0;r<i.length;r++){if(typeof i[r]!="string")continue;let a=!1,l=0,m=xe,w=[];typeof i[r+1]=="number"&&(a=!0,l=i[r+1]);let L=i[r];if(L[0]==="["){const Q=L.indexOf("]");w=L.slice(1,Q).split(""),L=L.slice(Q+1)}w.includes("~")&&(m=m*2),m>0?await Ke(L,m,w.includes("+")):w.includes("+")?f.innerText+=L:f.innerText=L,w.includes("+")&&I.pop(),I.push({id:this?.id??"[print]",label:this?.label??"[print]",text:f.innerText}),I.length>100&&I.shift(),a?f.classList.add(n+"-message-rendered-writing"):f.classList.add(n+"-message-rendered-stopped");let we;const De=new Promise((Q,Me)=>{we=Q,J=Me});U=()=>{f.classList.remove(n+"-message-rendered-writing"),f.classList.remove(n+"-message-rendered-stopped"),we()},F&&await y(v.BEFORE_SKIP_PRINTING),F?R(!0):a?(await y(l),R(!0)):G[" "]?(await y(v.BEFORE_IDLE_PROCEED),R(!0)):(A=!0,c.onStop?.(),await De)}j=!1}}async function Ne(...t){if(x(),o("\u{1F4CB}",t),j||V){console.error('Cannot show selectable options because the previous task was not finished. Check if you placed "await"s correctly.'),console.error("Options:",t);return}if(t=t.filter(e=>typeof e=="string"||e instanceof Object),!!t.length)return V=!0,A=!0,$.style.pointerEvents="all",C.replaceChildren(...t.map(e=>{const s=b(n+"-select-option");if(typeof e=="string")s.innerText=ne(e);else{const[i,r]=Object.entries(e)[0];s.innerText=ne(r),s.setAttribute("select-option-value",i)}return s})),C.classList.remove(n+"-select-hidden"),c.onShowOptions?.(),await y(v.BEFORE_SELECT_ACTIVE),new Promise((e,s)=>{J=s,z=e})}const fe=(t,...e)=>{const s=document.createElement(t);return s.classList.add(...e),s},b=fe.bind(null,"div"),pe=fe.bind(null,"span");function H(t){return new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(async()=>{await t(),e()})})})}function Pe(){const t=[];return{onWatcherCreate(e){document.querySelectorAll(`[${S}="${e}"]`).forEach(s=>{s.classList.add(n+"-watched"),s.addEventListener("click",se),t.push(s)})},onWatcherRemove(e){for(let s=t.length-1;s>=0;s--){const i=t[s];i.getAttribute(S)===e&&(i.classList.remove(n+"-watched"),i.removeEventListener("click",se),t.splice(s,1))}},onEventEnter(e){t.forEach(s=>{s.getAttribute(S)===e?s.classList.add(n+"-watched-clicked"):s.classList.add(n+"-watched-clicked-other")})},onEventLeave(){t.forEach(e=>{e.classList.remove(n+"-watched-clicked"),e.classList.remove(n+"-watched-clicked-other")})}}}function se(){N.notify(this.getAttribute(S))}function je(){document.removeEventListener("keydown",be),document.removeEventListener("keyup",ye),S&&document.querySelectorAll(`[${S}]`).forEach(t=>{t.removeEventListener("click",se),t.classList.remove(n+"-watched"),t.classList.remove(n+"-watched-clicked"),t.classList.remove(n+"-watched-clicked-other")})}function Fe(t,...e){if(!Object.hasOwn(T,t)){console.error("Trying to call unknown scene:",t);return}if(P>99){console.error(`Scene "${t}" cannot be called: stack size limit reached (${P}).`);return}return P+=1,o("\u{1F4AC}",t),(async()=>{c.onSceneEnter?.(t,!1);const s=await T[t].cb(de,...e);return c.onSceneLeave?.(t,!1),P-=1,P||o("\u26F0\uFE0F",p?.id,"\u21A9"),s})()}function We(...t){return ue.prototype.say.call(null,null,...t)}function He(){return u?.hide()}function y(t){return new Promise((e,s)=>{J=s,setTimeout(e,t)})}function ne(t){if(Z!==-1&&typeof t=="string"){const e=t.split(Oe);return Z<e.length?e[Z]:e[0]}return t}function qe(t,...e){let s="";for(let i=0;i<t.length;i++)s+=t[i],i<t.length-1&&(s+=`${e[i]}`);return s}function Ke(t,e,s){return t=ne(t),s||(f.innerText="",O.innerText=t),new Promise(i=>{const r=a=>{F?(f.innerText+=t.slice(a),s||(O.innerText=""),i()):a<t.length?setTimeout(()=>{f.innerText+=t[a],s||(O.innerText=t.slice(a+1)),c.onType?.(t[a]),r(a+1)},ee?0:e):i()};r(0)})}function o(...t){X&&console.log(...t.map(e=>e===he?me(d):e))}function me(t){return Object.fromEntries(Object.entries(t).filter(e=>!e[0].startsWith("__")))}const be=({key:t})=>{if(!G[t])switch(G[t]=!0,t){case" ":ee=!0,R();break;case"Control":R(),F=!0;break}},ye=({key:t})=>{switch(delete G[t],t){case" ":ee=!1;break;case"Control":F=!1;break}};return document.addEventListener("keydown",be),document.addEventListener("keyup",ye),N=new Re,Object.assign(_,{event:(t,...e)=>{N.notify(t,...e)},getHistory:()=>I,save:t=>{N.saveState(t)},clearSaveSlot:(t="autosave")=>{N.clearSaveSlot(t)},remove:()=>{M=!0,je(),W.remove();for(const t of Object.keys(c))c[t]=null;for(const t of Object.keys(g))g[t]=null;J?.(B)},sleep:y,log:o}),_};
