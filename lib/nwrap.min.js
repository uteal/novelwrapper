/*! NovelWrapper v0.3.3 | (c) 2024 uteal | MIT License */export default(H,q,{$:we={},ext:ge={},callbacks:k=[],devMode:X=!0,stepTime:ve=1e3/60,cssPrefix:n="novel",watchedAttr:S=void 0,imagesPath:ie="./images/",imagesType:xe="png",firstScene:Ee="start",skipRestoring:Le=!1,appendTo:K=document.body,implementations:Se={},delays:$e={},defaultAlign:re="right",multiLangSplitRegex:Oe=/\s+>>\s+/,language:Z=-1})=>{const ae="Naruto",Te=ie+(ie.at(-1)!=="/"?"/":""),Ce=xe.toLowerCase();let D=!1;const M="AbortSignal",_={},x=()=>{if(D)throw M},d={},C={},oe={},I=[],B={};let G,p,u,le,U,z,J,N=0,P=!1,V=!1,A=!1,Y=!1,ee=!1,j=!1,F,E,$,h,te,f,O,T;const v={CHARACTER_SHOW:350,CHARACTER_HIDE:350,CHARACTER_MOOD_CHANGE:100,BEFORE_SELECT_ACTIVE:350,AFTER_OPTION_CLICK:250,BEFORE_FIRST_PRINT:500,BEFORE_SKIP_PRINTING:200,BEFORE_IDLE_PROCEED:500},c={onGameStart:null,onShow:null,onHide:null,onType:null,onStop:null,onSceneEnter:null,onSceneLeave:null,onWatcherCreate:null,onWatcherRemove:null,onEventEnter:null,onEventLeave:null,onShowOptions:null,onOptionClick:null,onStateChange:null,onGameEnd:null},g={createKey:t=>`novel : ${H} : ${t}`,saveState:t=>{const e=g.createKey?.(t);localStorage.setItem(e,JSON.stringify(d))},loadState:t=>{const e=g.createKey?.(t);let s;try{s=JSON.parse(localStorage.getItem(e))}catch{}if(s)return l("\u21BB",H,t),s},clearSaveSlot:t=>{const e=g.createKey?.(t);localStorage.removeItem(e),l("\u{1F5D1}\uFE0F",H,t)}},ce=new Proxy(d,{set(t,e,s){return e.startsWith("__")?(console.error('Could not set property that starts with "__": such names are reserved by the engine.'),!1):(t[e]=s,c.onStateChange?.(e,s),!0)}}),he=new Proxy(oe,{get(t,e){return Object.hasOwn(t,e)||(t[e]=new de(e)),t[e].proxy}}),R=(t=!1)=>{if(!D&&(A||t)&&U){A=!1;const e=U;U=null,e()}},Ae=async({target:t})=>{if(!D&&A&&z&&t?.classList.contains(n+"-select-option")){A=!1,c.onOptionClick?.();const e=t.getAttribute("select-option-value")??[...T.querySelectorAll("."+n+"-select-option")].findIndex(i=>t===i);T.classList.add(n+"-select-hidden");const s=z;z=null,l("\u{1F449}",t.innerText),await y(v.AFTER_OPTION_CLICK),V=!1,s(e)}};class Re{constructor(){Object.assign(v,$e),F=b(n+"-container",n+"-layer"),E=b(n+"-dialogs",n+"-layer"),$=b(n+"-choices",n+"-layer"),h=b(n+"-textbox",n+"-textbox-hidden"),te=b(n+"-message"),f=fe(n+"-message-rendered"),O=fe(n+"-message-placeholder"),T=b(n+"-select",n+"-select-hidden"),F.append(E,$),te.append(f,O),h.append(te),E.append(h),$.append(T),E.addEventListener("click",()=>R()),T.addEventListener("click",s=>Ae(s)),Array.isArray(k)||(k=[k]),S&&k.push(Pe()),this.setCallbacks(k);for(const[s,i]of Object.entries(Se))Object.hasOwn(g,s)?g[s]=i:console.error(`Unknown name for implementation given: "${s}".`);this.getScenes(),typeof K=="string"&&(K=document.querySelector(K)),K.append(F);const e=!Le&&this.loadState("autosave");e&&e.__version===ae?Object.assign(d,e):(l("\u{1F3AC}",H),Object.assign(d,this.createNewState()),Object.assign(d,pe(we))),l("\u{1F4E6}",structuredClone(d)),W(()=>{this.runScene(d.__scene,!1),c.onGameStart?.(_)})}setCallbacks(e){const s=Object.fromEntries(Object.keys(c).map(i=>[i,[]]));for(const i of e)for(const[r,a]of Object.entries(i)){if(!Object.hasOwn(s,r)){console.error("Unknown callback:",r);continue}s[r].push(a)}for(const[i,r]of Object.entries(s))r.length>0&&(c[i]=r.length===1?r[0]:function(...a){r.forEach(o=>o.apply(this,a))})}getScenes(){Array.isArray(q)||(q=[q]);for(const e of q)Object.entries(e({$:ce,watch:Ie,select:Ne,call:Fe,print:We,clear:He,sleep:y,log:l,ext:ge})).forEach(([s,i])=>{Object.hasOwn(C,s)?console.error("Scene redeclaration:",s):C[s]=new ke(s,i)})}saveState(e){x(),g.saveState?.(e)}loadState(e){return x(),g.loadState?.(e)}clearSaveSlot(e){x(),g.clearSaveSlot?.(e)}createNewState(){return{__scene:Ee,__characters:{},__version:ae}}async runScene(e,s=!0){if(x(),l("\u26F0\uFE0F",e),e?.[0]==="~"?e=e.slice(1):u?.hide(),p&&p.end(),!Object.hasOwn(C,e)){console.error("Trying to run unknown scene:",e);return}p=C[e],d.__scene=e,s&&this.saveState("autosave"),c.onSceneEnter?.(e,!0);let i;try{i=await p.run()}catch(r){if(r===M){l("\u270B","The game was manually interrupted."),l("\u{1FA82}","Emergency exiting.");return}else throw r}c.onSceneLeave?.(e,!0),typeof i=="string"?setTimeout(()=>this.runScene(i)):i!==void 0&&(l("\u{1F3C1}","Game ended."),c.onGameEnd?.(i))}async notify(e,...s){if(x(),l("\u26A1",e),!p){console.error(`Event "${e}" occured while no scene is active`);return}if(!Y){console.error(`Event "${e}" occured while the script flow was not ended.`);return}const i=p.watchers.find(r=>r.event===e);if(!i){l("\u{1F965}","No such watcher.");return}if(!i.cb){l("\u{1F34B}","Callback not set.");return}if(i){Y=!1,c.onEventEnter?.(e,...s);let r;try{r=await i.cb(...s)}catch(a){if(a===M){l("\u270B","The game was manually interrupted."),l("\u{1FA82}","Emergency exiting.");return}else throw a}c.onEventLeave?.(e,r),typeof r=="string"?le(r):(r===!1&&p.removeWatcher(e),u?.hide(),$.style.pointerEvents="none",E.style.pointerEvents="none",Y=!0,l("\u26F0\uFE0F",p.id,"\u21A9"))}}}class ke{watchers=[];constructor(e,s){this.id=e,this.cb=s}async run(){let e=await this.cb(he);return e===void 0&&(this.watchers.length?(Y=!0,u?.hide(),$.style.pointerEvents="none",E.style.pointerEvents="none",F.style.pointerEvents="none",e=await new Promise(s=>{le=s})):l("\u{1F6A7}","The game has stalled.")),e}removeWatcher(e){const s=this.watchers.findIndex(i=>i.event===e);s!==-1&&(this.watchers.splice(s,1),c.onWatcherRemove?.(e),l("\u{1F9F9}",e))}end(){this.watchers.forEach(({event:e})=>{c.onWatcherRemove?.(e)}),this.watchers=[]}}function Ie(t,e){if(x(),p.watchers.some(i=>i.event===t)){console.error(`Multiple watchers of the same event (${t}) not allowed at scene (${p.id})`);return}l("\u{1F4CC}",t),p.watchers.push({event:t,cb:e}),c.onWatcherCreate?.(t);const s=p.id;return{then:()=>{console.error(`There is no point in "await" before "watch" (scene: "${s}", event: "${t}").`)}}}class de{constructor(e){l("\u{1F98A}",e),this.id=e,this.label="",this.align=re,this.flipped=!1,this.visible=!1,this.timeout,this.mood="normal",this.queue=[];let s="normal";const i=(...r)=>{if(X){for(const{id:a,queue:o}of Object.values(oe))if(o.length){console.error(`Unexpected state. Check the "await" before these words of ${a}:`,[...o]);return}}return this.proxy__(...r)};if(Object.assign(i,{$toLeft:()=>(this.setAlign("left"),d.__characters[e].align="left",this.proxy_),$toRight:()=>(this.setAlign("right"),d.__characters[e].align="right",this.proxy_),$setName:r=>(this.setLabel(r),d.__characters[e].label=r,this.proxy_),$flipImage:()=>(this.setFlip(!this.flipped),d.__characters[e].flipped=this.flipped,this.proxy_),then:()=>{console.error(`Seemingly useless "await" before ${this.id}'s handle. This error may be caused by:
1. Erroneous usage of "await" with syncronous methods like "$toLeft", "$toRight", "$setName".
2. Using quotes or double quotes instead of backticks in parenthesis-less notation.
3. Using a comma or semicolon before the first argument in parenthesis-less notation.`)}}),this.proxy=new Proxy(i,{get:(r,a)=>Object.hasOwn(r,a)?r[a]:(s=a,this.proxy__)}),this.proxy_=new Proxy(i,{apply:()=>{console.error("Direct function call in a method chain. Chaining of methods and function calls is prohibited.")}}),this.proxy__=new Proxy(i,{get:(r,a)=>{if(a==="then")return async(o,m)=>{const w=this.queue;this.queue=[],await this.say(s,...w).catch(m),s="normal",o()};console.error(`Once the call chain has started, property getting is not allowed. Requested property: "${a}".`)},apply:(r,a,o)=>(Array.isArray(o[0])&&Array.isArray(o[0].raw)&&(o=[qe(...o)]),this.queue.push(...o),this.proxy__)}),this.$el=b(n+"-character",n+"-character-id-"+e,n+"-character-align-"+this.align,n+"-character-inactive"),this.$portraits=b(n+"-character-portraits"),this.$label=b(n+"-label",n+"-label-id-"+e,n+"-label-hidden"),this.$el.append(this.$portraits,this.$label),Object.hasOwn(d.__characters,e)){const r=d.__characters[e];this.setLabel(r.label),this.setAlign(r.align),this.setFlip(r.flipped),l("\u21BB",r)}else d.__characters[e]={}}setLabel(e=""){this.$label.innerText=e,this.label=e,e?this.visible&&this.$label.classList.remove(n+"-label-hidden"):this.$label.classList.add(n+"-label-hidden")}setAlign(e=re){e!==this.align&&(this.$el.classList.remove(n+"-character-align-"+this.align),this.$el.classList.add(n+"-character-align-"+e),this.align=e,this.visible&&this.updateTextboxAlign())}setFlip(e=!1){this.flipped=e,e?this.$el.classList.add(n+"-character-flipped"):this.$el.classList.remove(n+"-character-flipped")}setMood(e){return e!==this.mood?(this.$el.classList.remove(n+"-character-mood-"+this.mood),this.$el.classList.add(n+"-character-mood-"+e),this.mood=e,!0):!1}async show(e=this.mood){const s=this.setMood(e),i=!!u&&u===this,r=!!u&&u.align===this.align;let a=this.$portraits.querySelector("."+n+"-portrait-mood-"+e);a?a.classList.contains(n+"-portrait-hidden")&&this.$portraits.append(a):(a=b(n+"-portrait",n+"-portrait-mood-"+e,n+"-portrait-hidden"),this.$portraits.append(a),await new Promise(o=>{let m=`${Te}${this.id}/${e}.${Ce}`;X&&(m+="?"+Math.random());const w=new Image;w.src=m,w.onload=()=>{a.style.backgroundImage=`url('${m}')`,o()},w.onerror=()=>{o()}})),i||(r?await u?.hide():u?.hide()),a.classList.contains(n+"-portrait-hidden")&&W(()=>{a.classList.remove(n+"-portrait-hidden")}),this.visible?await W(async()=>{await y(s?v.CHARACTER_MOOD_CHANGE:0);for(let o=0;o<this.$portraits.children.length-1;o++)this.$portraits.children[o].classList.add(n+"-portrait-hidden");this.updateTextboxAlign()}):(this.visible=!0,u=this,f.innerText="",O.innerText="",E.append(this.$el),clearTimeout(this.timeout),c.onShow?.(this.id),await W(()=>{this.$el.classList.remove(n+"-character-inactive"),h.classList.remove(n+"-textbox-hidden");for(let o=h.classList.length-1;o>=0;o--){const m=h.classList[o];m.startsWith(n+"-textbox-of-")&&h.classList.remove(m)}h.classList.add(n+"-textbox-of-"+this.id),this.updateTextboxAlign()}),this.label?this.$label.classList.remove(n+"-label-hidden"):this.$label.classList.add(n+"-label-hidden"),await y(v.CHARACTER_SHOW))}async hide(){if(this.visible){this.visible=!1,u=void 0,this.$el.classList.remove(n+"-character-mood-"+this.mood),this.$el.classList.add(n+"-character-inactive"),this.$label.classList.add(n+"-label-hidden");for(const e of this.$portraits.children)e.classList.add(n+"-portrait-hidden");await W(()=>{P||h.classList.add(n+"-textbox-hidden")}),c.onHide?.(this.id),this.timeout=setTimeout(()=>this.$el.remove(),5e3),await y(v.CHARACTER_HIDE)}}updateTextboxAlign(){this.align==="left"?(h.classList.remove(n+"-textbox-right"),h.classList.add(n+"-textbox-left")):(h.classList.remove(n+"-textbox-left"),h.classList.add(n+"-textbox-right"))}async say(e,...s){if(x(),P||V){console.error("Message from "+(this?.id??"[print]")+' was ignored because the previous task was not finished. Check if you placed "await"s correctly.'),console.error("Message:",s);return}P=!0,E.style.pointerEvents="all",$.style.pointerEvents="none";const i=[];for(const r of s)Array.isArray(r)?i.push(...r):i.push(r);if(this)h.classList.remove(n+"-textbox-printed"),await this.show(e);else{const r=h.classList.contains(n+"-textbox-hidden"),a=r||!!u;u?.hide(),f.innerText="",O.innerText="",h.classList.remove(n+"-textbox-left"),h.classList.remove(n+"-textbox-right"),h.classList.add(n+"-textbox-printed"),r&&h.classList.remove(n+"-textbox-hidden"),a&&await y(v.BEFORE_FIRST_PRINT)}for(let r=0;r<i.length;r++){if(typeof i[r]!="string")continue;let a=!1,o=0,m=ve,w=[];typeof i[r+1]=="number"&&(a=!0,o=i[r+1]);let L=i[r];if(L[0]==="["){const Q=L.indexOf("]");w=L.slice(1,Q).split(""),L=L.slice(Q+1)}w.includes("~")&&(m=m*2),m>0?await Ke(L,m,w.includes("+")):w.includes("+")?f.innerText+=L:f.innerText=L,w.includes("+")&&I.pop(),I.push({id:this?.id??"[print]",label:this?.label??"[print]",text:f.innerText}),I.length>100&&I.shift(),a?f.classList.add(n+"-message-rendered-writing"):f.classList.add(n+"-message-rendered-stopped");let ye;const De=new Promise((Q,Me)=>{ye=Q,J=Me});U=()=>{f.classList.remove(n+"-message-rendered-writing"),f.classList.remove(n+"-message-rendered-stopped"),ye()},j&&await y(v.BEFORE_SKIP_PRINTING),j?R(!0):a?(await y(o),R(!0)):B[" "]?(await y(v.BEFORE_IDLE_PROCEED),R(!0)):(A=!0,c.onStop?.(),await De)}P=!1}}async function Ne(...t){if(x(),l("\u{1F4CB}",t),P||V){console.error('Cannot show selectable options because the previous task was not finished. Check if you placed "await"s correctly.'),console.error("Options:",t);return}if(t=t.filter(e=>typeof e=="string"||e instanceof Object),!!t.length)return V=!0,A=!0,$.style.pointerEvents="all",T.replaceChildren(...t.map(e=>{const s=b(n+"-select-option");if(typeof e=="string")s.innerText=ne(e);else{const[i,r]=Object.entries(e)[0];s.innerText=ne(r),s.setAttribute("select-option-value",i)}return s})),T.classList.remove(n+"-select-hidden"),c.onShowOptions?.(),await y(v.BEFORE_SELECT_ACTIVE),new Promise((e,s)=>{J=s,z=e})}const ue=(t,...e)=>{const s=document.createElement(t);return s.classList.add(...e),s},b=ue.bind(null,"div"),fe=ue.bind(null,"span");function W(t){return new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(async()=>{await t(),e()})})})}function Pe(){const t=[];return{onWatcherCreate(e){document.querySelectorAll(`[${S}="${e}"]`).forEach(s=>{s.classList.add(n+"-watched"),s.addEventListener("click",se),t.push(s)})},onWatcherRemove(e){for(let s=t.length-1;s>=0;s--){const i=t[s];i.getAttribute(S)===e&&(i.classList.remove(n+"-watched"),i.removeEventListener("click",se),t.splice(s,1))}},onEventEnter(e){t.forEach(s=>{s.getAttribute(S)===e?s.classList.add(n+"-watched-clicked"):s.classList.add(n+"-watched-clicked-other")})},onEventLeave(){t.forEach(e=>{e.classList.remove(n+"-watched-clicked"),e.classList.remove(n+"-watched-clicked-other")})}}}function se(){G.notify(this.getAttribute(S))}function je(){document.removeEventListener("keydown",me),document.removeEventListener("keyup",be),S&&document.querySelectorAll(`[${S}]`).forEach(t=>{t.removeEventListener("click",se),t.classList.remove(n+"-watched"),t.classList.remove(n+"-watched-clicked"),t.classList.remove(n+"-watched-clicked-other")})}function Fe(t,...e){if(!Object.hasOwn(C,t)){console.error("Trying to call unknown scene:",t);return}if(N>99){console.error(`Scene "${t}" cannot be called: stack size limit reached (${N}).`);return}return N+=1,l("\u{1F4AC}",t),(async()=>{c.onSceneEnter?.(t,!1);const s=await C[t].cb(he,...e);return c.onSceneLeave?.(t,!1),N-=1,N||l("\u26F0\uFE0F",p?.id,"\u21A9"),s})()}function We(...t){return de.prototype.say.call(null,null,...t)}function He(){return u?.hide()}function y(t){return new Promise((e,s)=>{J=s,setTimeout(e,t)})}function ne(t){if(Z!==-1&&typeof t=="string"){const e=t.split(Oe);return Z<e.length?e[Z]:e[0]}return t}function qe(t,...e){let s="";for(let i=0;i<t.length;i++)s+=t[i],i<t.length-1&&(s+=`${e[i]}`);return s}function Ke(t,e,s){return t=ne(t),s||(f.innerText="",O.innerText=t),new Promise(i=>{const r=a=>{j?(f.innerText+=t.slice(a),s||(O.innerText=""),i()):a<t.length?setTimeout(()=>{f.innerText+=t[a],s||(O.innerText=t.slice(a+1)),c.onType?.(t[a]),r(a+1)},ee?0:e):i()};r(0)})}function l(...t){X&&console.log(...t.map(e=>e===ce?pe(d):e))}function pe(t){return Object.fromEntries(Object.entries(t).filter(e=>!e[0].startsWith("__")))}const me=({key:t})=>{if(!B[t])switch(B[t]=!0,t){case" ":ee=!0,R();break;case"Control":R(),j=!0;break}},be=({key:t})=>{switch(delete B[t],t){case" ":ee=!1;break;case"Control":j=!1;break}};return document.addEventListener("keydown",me),document.addEventListener("keyup",be),G=new Re,Object.assign(_,{event:(t,...e)=>{G.notify(t,...e)},getHistory:()=>I,clearSaveSlot:(t="autosave")=>{G.clearSaveSlot(t)},remove:()=>{D=!0,je(),F.remove();for(const t of Object.keys(c))c[t]=null;for(const t of Object.keys(g))g[t]=null;J?.(M)},sleep:y,log:l}),_};
